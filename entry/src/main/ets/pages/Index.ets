import { abilityAccessCtrl, common, Context, PermissionRequestResult ,Permissions } from '@kit.AbilityKit';
import { sensor } from '@kit.SensorServiceKit';
import { BusinessError } from '@kit.BasicServicesKit';
import {power} from '@kit.BasicServicesKit';
import window from '@ohos.window';
import { geoLocationManager } from '@kit.LocationKit';

@Entry
@Component
struct Index {
  @State heartRate: number = 0;
  @State location: Array<number> = [0,0]; //[0]ç»åº¦ [1]çº¬åº¦
  //è¯·æ±‚ä½ç½®ä¿¡æ¯çš„å‚æ•°
  request: geoLocationManager.ContinuousLocationRequest= {
    //é«˜åŠŸè€—å®šä½
    locationScenario: geoLocationManager.PowerConsumptionScenario.HIGH_POWER_CONSUMPTION,
    //å®æ—¶ä¸ŠæŠ¥å®šä½
    interval:0
  };

  build() {
    Column() {
      Text(`æ°´ä¸Šè¿åŠ¨ç›‘æµ‹`)
        .fontSize(25)
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Center)
        .margin({ bottom: 15 })
      Text(`â¤ï¸ å¿ƒç‡ï¼š${this.heartRate} bpm`)
        .fontSize(20)
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Center)
        .margin({ bottom: 12 })
      Text(`ğŸ“ ç»åº¦ï¼š${this.location[0].toFixed(6)}`)
        .fontSize(20)
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Center)
        .margin({ bottom: 12 })
      Text(`ğŸ“ çº¬åº¦ï¼š${this.location[1].toFixed(6)}`)
        .fontSize(20)
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .backgroundColor(0x000000)
  }

  aboutToAppear() {
    this.requestHeartRatePermissionAndStart();
    this.keepScreenOn(true);
  }

  //è®¾ç½®å±å¹•å¸¸äº®
  async keepScreenOn(enable: boolean) {
    try {
      const win = await window.getLastWindow(getContext(this));
      await win.setWindowKeepScreenOn(enable);
    } catch (err) {
      console.error('è®¾ç½®å±å¹•å¸¸äº®å¤±è´¥:', JSON.stringify(err));
    }
  }

  //æƒé™è·å–
  async requestHeartRatePermissionAndStart() {
    const atManager = abilityAccessCtrl.createAtManager();
    const context = getContext(this) as common.UIAbilityContext;

    const permissions: Permissions[] = [
      'ohos.permission.READ_HEALTH_DATA' as Permissions,
      'ohos.permission.LOCATION' as Permissions,
      'ohos.permission.APPROXIMATELY_LOCATION' as Permissions
    ];

    atManager.requestPermissionsFromUser(
      context,
      permissions,
      (err: BusinessError, data: PermissionRequestResult) => {
        if (err) {
          console.error(`æƒé™è¯·æ±‚å¤±è´¥: code=${err.code}, message=${err.message}`);
          return;
        }

        // éå†æˆæƒç»“æœ
        for (let i = 0; i < data.authResults.length; i++) {
          if (data.authResults[i] !== 0) {
            console.warn(`æƒé™ ${data.permissions[i]} è¢«æ‹’ç»!`);
          }
          else {
            console.log(`æƒé™ ${data.permissions[i]} è¢«é€šè¿‡`);
          }
        }

        // åˆ¤æ–­æ˜¯å¦å…¨éƒ¨æˆæƒ
        const allGranted = data.authResults.every(result => result === 0);
        if (allGranted) {
          console.info('æ‰€æœ‰æƒé™å·²æˆæƒï¼Œå¼€å§‹å¿ƒç‡ä¸å®šä½åŠŸèƒ½');
          this.startHeartRateSensor(); // å¿ƒç‡è®¢é˜…å‡½æ•°
          this.startLocationService(); // å®šä½
        } else {
          console.warn('éƒ¨åˆ†æƒé™æœªæˆæƒï¼ŒåŠŸèƒ½å¯èƒ½å—é™');
          this.startHeartRateSensor();
          this.startLocationService();
        }
      }
    );
  }

  async startLocationService() {
    try{
      geoLocationManager.on('locationChange',this.request, (location: geoLocationManager.Location) => {
        console.log('å®æ—¶å®šä½ï¼šçº¬åº¦=', location.latitude, ' ç»åº¦=', location.longitude)
        this.location[0] = location.longitude;
        this.location[1] = location.latitude;
      })
    }
    catch(error){
      console.error('å®šä½å¤±è´¥ï¼š'+ error.message);}
    // throw new Error('Method not implemented.');
  }

  startHeartRateSensor() {
    try {
      sensor.on(sensor.SensorId.HEART_RATE, (data: sensor.HeartRateResponse) => {
        this.heartRate = data.heartRate;
      }, { interval: 100000000 }); // æ¯100msæ›´æ–°ä¸€æ¬¡
    } catch (err) {
      let e = err as BusinessError;
      console.error(`å¿ƒç‡è®¢é˜…å¤±è´¥ï¼Œé”™è¯¯ç : ${e.code}, ä¿¡æ¯: ${e.message}`);
    }
  }

  aboutToDisappear() {
    try {
      sensor.off(sensor.SensorId.HEART_RATE);
      geoLocationManager.off('locationChange');
      console.log('å®šä½æœåŠ¡å…³é—­');
    } catch (err) {
      let e = err as BusinessError;
      console.error("errCode:" + JSON.stringify(err));
    }
    this.keepScreenOn(false);
  }

}